
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Bill</title>
	<meta name="author" content="Bill Sion">

	
	<meta name="description" content="昨天下午遇到了個頭疼的問題，客戶對產品評論的時間總是晚於客服回復的時間，這個根本說不通，按照常理來講，只能先評論，客服才能對評論進行回復。知道問題所在，於是開始DEBUG。 首先檢查對應的模塊有沒有被重寫，查看config.xml配置文件裏的&lt;rewrite&gt;項，沒有重寫， &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Bill" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Bill</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:billsion.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:billsion.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/06/18/magento-review-time-zone-configuration/">
		
			在Magento產品評論中出現的時區問題</a>
	</h2>
	<div class="entry-content">
		<p>昨天下午遇到了個頭疼的問題，客戶對產品評論的時間總是晚於客服回復的時間，這個根本說不通，按照常理來講，只能先評論，客服才能對評論進行回復。知道問題所在，於是開始DEBUG。</p>

<ul>
<li><p>首先檢查對應的模塊有沒有被重寫，查看<code>config.xml</code>配置文件裏的<code>&lt;rewrite&gt;</code>項，沒有重寫，證明Model是幹凈的。同時再看Controller部分有沒有問題，也沒有，說明根本沒有重寫這個模塊。</p></li>
<li><p>再檢查是否有顯示的設置了<code>created_at</code>或是<code>updated_at</code>時間，在代碼裏。結果也是沒有。</p></li>
</ul>


<p>這就奇怪了，於是接下來檢查PHP和MYSQL的時區設置。</p>

<ul>
<li><p>寫個腳本查看phpinfo()或是<code>php.ini</code>，時區是 <code>Asia/Shanghai</code>，沒問題，是對的。</p></li>
<li><p>在MySQL裏運行 <code>show variables like '%time_zone%'</code>; 發現 <code>default_time_zone</code>是用的<code>SYSTEM</code>，於是在 <code>/etc/my.cnf</code> 裏加一句 <code>default_time_zone='+8:00'</code>，重啟MySQL。搞掟時區問題。</p></li>
</ul>


<p>現在時區顯示是對了，但是時間還是不對，於是查看對應表<code>review</code>的schema發現，<code>created_at</code>這裏填寫的是 <code>CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code>，這就是原因，這就是為什麼回復評論的時間在評論創建的時間之前。可以給Magento提交BUG了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-18T11:15:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/06/07/upgrade-php-version-in-mac-os-x/">
		
			在Mac OS X里面升级原生PHP</a>
	</h2>
	<div class="entry-content">
		<p>目前机器上的PHP版本是5.3.15，低了，想升到5.4，于是百度搜了下，出来的都是三条语句升级:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew tap homebrew/dupes
</span><span class='line'>brew tap josegonzalez/homebrew-php
</span><span class='line'>brew install hp54</span></code></pre></td></tr></table></div></figure>


<p>实际上这样并不能安装成功，因为目标文件已经不存在了。于是求助Google，在StackOverflow上找到了答案。<a href="http://php-osx.liip.ch/">这里</a></p>

<p>一句话就OK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -s http://php-osx.liip.ch/install.sh | bash -s 5.4</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-07T10:18:00+08:00" pubdate data-updated="true">Jun 7<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/mac/'>Mac</a>, <a class='category' href='/blog/categories/php/'>PHP,</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/06/03/create-a-custom-router-in-magento/">
		
			在Magento里面创建一个自定义路由</a>
	</h2>
	<div class="entry-content">
		<p>本文译自<a href="http://inchoo.net/ecommerce/magento/custom-router-in-magento/">Inchoo</a></p>

<p>当我们需要把业务逻辑从Magento默认的路由中区别开来，不受Magento默认路由的影响，创建一个自定义的路由功能就显得很方便了。</p>

<p>那为什么我们不能为不同的逻辑创建不同的路由呢？</p>

<p>让我来简单解释一下：在我的一个客户的项目中，我整合过一个 <code>OneStepCheckout</code> 的扩展，这个扩展重写了Magento核心的路由功能。我需要重写这些路由甚至要根据URL里的参数把它们分派到两个不同的控制器。基于这要的要求，我发现最节省时间的方法便是创建一个新路由，由它来根据不同的参数重定向到不同的控制器。</p>

<p>我们来开始定义:</p>

<p><strong>../app/code/local/Mynamespace/Myextension/etc/config.xml</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;default&gt;
</span><span class='line'>   &lt;web&gt;
</span><span class='line'>     &lt;routers&gt;
</span><span class='line'>        &lt;myextension_myrouter&gt;
</span><span class='line'>            &lt;area&gt;frontend&lt;/area&gt;
</span><span class='line'>            &lt;class&gt;Mynamespace_Myextension_Controller_Router&lt;/class&gt;
</span><span class='line'>        &lt;/myextension_myrouter&gt;
</span><span class='line'>    &lt;/routers&gt;
</span><span class='line'>   &lt;/web&gt;
</span><span class='line'>  &lt;/default&gt;
</span><span class='line'>&lt;/stores&gt;</span></code></pre></td></tr></table></div></figure>


<p>在 <strong>/app/code/local/Mynamespace/Myextension</strong>里创建一个新文件夹，名为 <strong>Controller</strong>。也创建一个PHP类: <strong>Mynamespace_Myextension_Controller_Router.php</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>//Mynamespace_Myextension_Controller_Router.php
</span><span class='line'>/**
</span><span class='line'> * @author Darko Goleš &lt;darko.goles@inchoo.net&gt;
</span><span class='line'> * Router for deciding to go on party checkout or regular onestepcheckout
</span><span class='line'> */
</span><span class='line'>class Mynemaspace_Myextension_Controller_Router extends Mage_Core_Controller_Varien_Router_Standard {
</span><span class='line'>}
</span><span class='line'>?&gt;</span></code></pre></td></tr></table></div></figure>


<p>为了避免重复发明轮子，我们可以直接从已有的源代码<strong>Mage_Core_Controller_Varien_Router_Standard.php</strong>中复制出内容并粘贴到我们的文件里，同时作些修改:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'>   * Match the request
</span><span class='line'>   *
</span><span class='line'>   * @param Zend_Controller_Request_Http $request
</span><span class='line'>   * @return boolean
</span><span class='line'>   */
</span><span class='line'>  public function match(Zend_Controller_Request_Http $request)
</span><span class='line'>  {
</span><span class='line'>      //checking before even try to find out that current module
</span><span class='line'>      //should use this router
</span><span class='line'>      if (!$this-&gt;_beforeModuleMatch()) {
</span><span class='line'>          return false;
</span><span class='line'>      }
</span><span class='line'>      $this-&gt;fetchDefault();
</span><span class='line'>      $front = $this-&gt;getFront();
</span><span class='line'>      $path = trim($request-&gt;getPathInfo(), '/');
</span><span class='line'>      if ($path) {
</span><span class='line'>          $p = explode('/', $path);
</span><span class='line'>      } else {
</span><span class='line'>          $p = explode('/', $this-&gt;_getDefaultPath());
</span><span class='line'>      }
</span><span class='line'>      // get module name
</span><span class='line'>      if ($request-&gt;getModuleName()) {
</span><span class='line'>          $module = $request-&gt;getModuleName();
</span><span class='line'>      } else {
</span><span class='line'>          if (!empty($p[0])) {
</span><span class='line'>              $module = $p[0];
</span><span class='line'>          } else {
</span><span class='line'>              $module = $this-&gt;getFront()-&gt;getDefault('module');
</span><span class='line'>              $request-&gt;setAlias(Mage_Core_Model_Url_Rewrite::REWRITE_REQUEST_PATH_ALIAS, '');
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>      if (!$module) {
</span><span class='line'>          if (Mage::app()-&gt;getStore()-&gt;isAdmin()) {
</span><span class='line'>              $module = 'admin';
</span><span class='line'>          } else {
</span><span class='line'>              return false;
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>      /**
</span><span class='line'>       * Searching router args by module name from route using it as key
</span><span class='line'>       */
</span><span class='line'>      $modules = $this-&gt;getModuleByFrontName($module);
</span><span class='line'>      if ($modules === false) {
</span><span class='line'>          return false;
</span><span class='line'>      }
</span><span class='line'>      //checkings after we foundout that this router should be used for current module
</span><span class='line'>      if (!$this-&gt;_afterModuleMatch()) {
</span><span class='line'>          return false;
</span><span class='line'>      }
</span><span class='line'>      /**
</span><span class='line'>       * Going through modules to find appropriate controller
</span><span class='line'>       */
</span><span class='line'>      $found = false;
</span><span class='line'>      foreach ($modules as $realModule) {
</span><span class='line'>          $request-&gt;setRouteName($this-&gt;getRouteByFrontName($module));
</span><span class='line'>          // get controller name
</span><span class='line'>          if ($request-&gt;getControllerName()) {
</span><span class='line'>              $controller = $request-&gt;getControllerName();
</span><span class='line'>          } else {
</span><span class='line'>              if (!empty($p[1])) {
</span><span class='line'>                  $controller = $p[1];
</span><span class='line'>              } else {
</span><span class='line'>                  $controller = $front-&gt;getDefault('controller');
</span><span class='line'>                  $request-&gt;setAlias(
</span><span class='line'>                      Mage_Core_Model_Url_Rewrite::REWRITE_REQUEST_PATH_ALIAS,
</span><span class='line'>                      ltrim($request-&gt;getOriginalPathInfo(), '/')
</span><span class='line'>                  );
</span><span class='line'>              }
</span><span class='line'>          }
</span><span class='line'>          // get action name
</span><span class='line'>          if (empty($action)) {
</span><span class='line'>              if ($request-&gt;getActionName()) {
</span><span class='line'>                  $action = $request-&gt;getActionName();
</span><span class='line'>              } else {
</span><span class='line'>                  $action = !empty($p[2]) ? $p[2] : $front-&gt;getDefault('action');
</span><span class='line'>              }
</span><span class='line'>          }
</span><span class='line'>          //checking if this place should be secure
</span><span class='line'>          $this-&gt;_checkShouldBeSecure($request, '/'.$module.'/'.$controller.'/'.$action);
</span><span class='line'>          $controllerClassName = $this-&gt;_validateControllerClassName($realModule, $controller);
</span><span class='line'>          if (!$controllerClassName) {
</span><span class='line'>              continue;
</span><span class='line'>          }
</span><span class='line'>          // instantiate controller class
</span><span class='line'>          $controllerInstance = Mage::getControllerInstance($controllerClassName, $request, $front-&gt;getResponse());
</span><span class='line'>          if (!$controllerInstance-&gt;hasAction($action)) {
</span><span class='line'>              continue;
</span><span class='line'>          }
</span><span class='line'>          $found = true;
</span><span class='line'>          break;
</span><span class='line'>      }
</span><span class='line'>      /**
</span><span class='line'>       * if we did not found any siutibul
</span><span class='line'>       */
</span><span class='line'>      if (!$found) {
</span><span class='line'>          if ($this-&gt;_noRouteShouldBeApplied()) {
</span><span class='line'>              $controller = 'index';
</span><span class='line'>              $action = 'noroute';
</span><span class='line'>              $controllerClassName = $this-&gt;_validateControllerClassName($realModule, $controller);
</span><span class='line'>              if (!$controllerClassName) {
</span><span class='line'>                  return false;
</span><span class='line'>              }
</span><span class='line'>              // instantiate controller class
</span><span class='line'>              $controllerInstance = Mage::getControllerInstance($controllerClassName, $request,
</span><span class='line'>                  $front-&gt;getResponse());
</span><span class='line'>              if (!$controllerInstance-&gt;hasAction($action)) {
</span><span class='line'>                  return false;
</span><span class='line'>              }
</span><span class='line'>          } else {
</span><span class='line'>              return false;
</span><span class='line'>          }
</span><span class='line'>      }
</span><span class='line'>      // set values only after all the checks are done
</span><span class='line'>      $request-&gt;setModuleName($module);
</span><span class='line'>      $request-&gt;setControllerName($controller);
</span><span class='line'>      $request-&gt;setActionName($action);
</span><span class='line'>      $request-&gt;setControllerModule($realModule);
</span><span class='line'>      // set parameters from pathinfo
</span><span class='line'>      for ($i = 3, $l = sizeof($p); $i &lt; $l; $i += 2) {
</span><span class='line'>          $request-&gt;setParam($p[$i], isset($p[$i+1]) ? urldecode($p[$i+1]) : '');
</span><span class='line'>      }
</span><span class='line'>      // dispatch action
</span><span class='line'>      $request-&gt;setDispatched(true);
</span><span class='line'>      $controllerInstance-&gt;dispatch($action);
</span><span class='line'>      return true;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>打个比方，现在我想要根据&#8221;Party&#8221;是否定义来重定向路由到不同的控制器。&#8221;Party&#8221;是前缀，那么正常的控制器会是这样:
<strong>Mynamespace/MyExtension/controllers/Somecontrollername.php</strong>
加了&#8221;Party&#8221;之后的控制器会是这样:
<strong>Mynamespace/MyExtension/controllers/</strong><em>Party</em><strong>/Somecontrollername.php</strong></p>

<p>为了实现这个，让我们在上面的代码中57~62行加入下面的代码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//...
</span><span class='line'>        $party_prefix = '';
</span><span class='line'>        if ($this-&gt;isPartyOrder($request)) {
</span><span class='line'>            foreach ($modules as $key =&gt; $realModule) {
</span><span class='line'>                $modules[$key].='_Party';
</span><span class='line'>            }
</span><span class='line'>            $party_prefix = '_party';
</span><span class='line'>        }
</span><span class='line'>//...</span></code></pre></td></tr></table></div></figure>


<p>当然，我们的<code>isParty</code>方法会是这样:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>..
</span><span class='line'>    /**
</span><span class='line'>     * Determine if order is "Party order"
</span><span class='line'>     * @param Mage_Core_Controller_Request_Http $request
</span><span class='line'>     * @return boolean
</span><span class='line'>     */
</span><span class='line'>    private function isPartyOrder($request) {
</span><span class='line'>        if (isset($_SESSION['is_party_checkout']) && $_SESSION['is_party_checkout']) {
</span><span class='line'>            return true;
</span><span class='line'>        }
</span><span class='line'>        $pathInfo = $request-&gt;getPathInfo();
</span><span class='line'>        if (stristr($pathInfo, 'onestepcheckout/index/index')) {
</span><span class='line'>            $params = Mage::app()-&gt;getRequest()-&gt;getParams();
</span><span class='line'>            if (isset($params['id'])) {
</span><span class='line'>                return true;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        return false;
</span><span class='line'>    }
</span><span class='line'>..
</span></code></pre></td></tr></table></div></figure>


<p>这里这段代码检查了<code>Party</code>是按照Session排序还是按照GET里的顺序排序。</p>

<p>按下来，我们将把下面的代码改一下，以便适应我们layout.xml里面用到的路由名字。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'>       * Going through modules to find appropriate controller
</span><span class='line'>       */
</span><span class='line'>      $found = false;
</span><span class='line'>      foreach ($modules as $realModule) {
</span><span class='line'>          $request-&gt;setRouteName($this-&gt;getRouteByFrontName($module));</span></code></pre></td></tr></table></div></figure>


<p>…我们只改一行:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//...
</span><span class='line'>        /**
</span><span class='line'>         * Going through modules to find appropriate controller
</span><span class='line'>         */
</span><span class='line'>        $found = false;
</span><span class='line'>        foreach ($modules as $realModule) {
</span><span class='line'>            $request-&gt;setRouteName('ourextension_' . $this-&gt;getRouteByFrontName($module) . $party_prefix);
</span><span class='line'>        ...
</span><span class='line'>//...</span></code></pre></td></tr></table></div></figure>


<p>现在我们可以在layout.xml文件里定义我们的layaout处理带&#8221;Party&#8221;的控制器和带规控制器:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0"?&gt;
</span><span class='line'>&lt;layout version="0.1.0"&gt;
</span><span class='line'>    &lt;ourmodule_controllername_actionname&gt;
</span><span class='line'>      &lt;block ....... some layout updates ... etc
</span><span class='line'>    &lt;/ourmodule_controllername_actionname&gt;
</span><span class='line'>   &lt;ourmodule_party_controllername_actionname&gt;
</span><span class='line'>      &lt;block ....... some different layout updates ... etc
</span><span class='line'>   &lt;/ourmodule_party_controllername_actionname&gt;
</span><span class='line'>&lt;/layout&gt;</span></code></pre></td></tr></table></div></figure>


<p>这样的话，就可以完完全全将两种情况分开来处理了。</p>

<p>这里只是个展示怎么创建和修改自定义路由的小例子，你可以根据实际情况将路由写成自己需要的那样。</p>

<p>让我们再来看看我写的模块里<code>config.xml</code>里面，路由是怎么和<code>Onestepcheckout</code>交互的:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;frontend&gt;
</span><span class='line'>        &lt;routers&gt;
</span><span class='line'>            &lt;onestepcheckout&gt;
</span><span class='line'>                &lt;use&gt;myextension_myrouter&lt;/use&gt;
</span><span class='line'>                &lt;args&gt;
</span><span class='line'>                    &lt;modules&gt;
</span><span class='line'>                        &lt;Mynamespace_Mymodule before="Idev_OneStepCheckout"&gt;Mynamespace_Mymodule_Onestepcheckout&lt;/Mynamespace_Mymodule&gt;
</span><span class='line'>                    &lt;/modules&gt;
</span><span class='line'>                &lt;/args&gt;
</span><span class='line'>            &lt;/onestepcheckout&gt;
</span><span class='line'>        &lt;/routers&gt;</span></code></pre></td></tr></table></div></figure>


<p>现在的问题便是:
<code>Onestepcheckout</code>模块重写了Magento的核心路由，所以当用户访问 <code>checkout/onepage</code> 的地址时，他们将会被定向到<code>Onepagecheckout</code>的URL。</p>

<p>当我像上面这样创建了自定义路由之后，用户将仍然访问<code>Onepagecheckout</code>的路由，除非有&#8221;Party&#8221;。</p>

<p>因为这两次请求（Party或是常规）都是同一文件，我们只是在我们的路由设置里设置了不同的路由名字，所以我们可以在layout里面用到不同的处理。</p>

<p>I know this seems a little bit messy for one reading, but I hope somebody will find this post useful for own projects and extension integrations and customizations. Cheers.</p>

<p>我知道把不同的请求放入一个文件里看起来有些混乱，但我希望此文起到一个抛砖引玉的作用，有人能够看到此文中有用的地方并用到自己的项目里。</p>

<p>谢谢。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-03T11:37:00+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento-fan-yi/'>Magento,翻译</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/06/03/understanding-the-grid-serializer-block/">
		
			理解Magento中序例化Block</a>
	</h2>
	<div class="entry-content">
		<p>本文译自: <a href="http://magebase.com/magento-tutorials/understanding-the-grid-serializer-block/">magebase.com</a></p>

<h3>多选框的不足之处</h3>

<p>在电商平台上，很多情况下都存在一对多的关系。举几个熟悉的例子，像追加销售，交叉销售，相关产品这些情况。一个产品可能会对应不只一个促销。我们用追加销售来打比方，一个产品可以对应多个作为追加销售存在的产品。 通常情况下是在表单或是管理页面中使用多选框来管理此类数据或是关系，但是这样有几个不足：</p>

<ol>
<li>只能显示产品的一个属性。在这个例子中，我们只能显示产品名字在多选框里，但是要显示如SKU或是价格之类的属性的话，就不是那么容易就能办到的。</li>
<li>用户只能选择多个产品，仅仅是选中，对额外数据无能为力。在这个例子中，表单只能提交选中的产品，但对各个选中产品的排列位置无能为力。</li>
<li>数据量的增多会导制选项增多，多选框会变得庞大，难以管理。</li>
<li>不能排序或是过滤，用户在找特定选项的时候会很困难。</li>
</ol>


<h3>作为表单元素的表格组件</h3>

<p>为了克服多选框的局限性，我们需要有一个高级的表单元素，它应该包含如下功能：</p>

<ol>
<li>可以正选/反选多个实体。</li>
<li>可以显示实体更多的信息。</li>
<li>可以保存用户输入的额外数据。</li>
<li>当数据量大的情况下，支持分页。</li>
<li>支持复杂排序和过滤。</li>
<li>格式应该统一，这样一来可以用在不同的实体或是不同的数据。</li>
</ol>


<p>幸运的是，Magento自带一些非常有意思的管理组件，特别是涉汲到后台插件的开发。这些组件太强大了，开发人员只需要写很少的代码或是&#8217;不&#8217;写模板便能创建出很直观的页面了。</p>

<p>其中一个组件便是“表格”。 它内置了分页，排序和过滤。表格组件广泛用于后台管理界面，比如用来显示产品，订单，发票，注册用户等。但是我最中意的使 用便是作为表单元素。Magento提供了一个非常完美的解决方案用来克服之前说到的那些个不足，什么一对多啊之类的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$this-&gt;addColumn('in_products', array(
</span><span class='line'>    'header_css_class' =&gt; 'a-center',
</span><span class='line'>    'type'            =&gt; 'checkbox',
</span><span class='line'>    'name'            =&gt; 'in_products',
</span><span class='line'>    'values'          =&gt; $this-&gt;_getSelectedProducts(),
</span><span class='line'>    'align'           =&gt; 'center',
</span><span class='line'>    'index'           =&gt; 'entity_id'
</span><span class='line'> ));
</span></code></pre></td></tr></table></div></figure>


<p>当用表格作为表单元素来替代多选框时，正常情况下，第一列的类型应该设为&#8217;checkbox&#8217;。这样一来，表格的每一行的第一列都会显示为checkbox。用户也就可以更好的选中他们想选择的数据。用此种方法进行多选比使用老式的多选框有效率多了。</p>

<h3>AJAX之间数据的可持久性</h3>

<p>第一眼看，此种机制堪称完美。但，表格同样也有分页，排序和过滤。每次执行其中的操作时，表格就通过AJAX调用进行重新加载，每次表格重新加载，之前选中的实体便会丢失。打个比方，我们正在选择追加销售商品，我们通过表格第一列的checkbo选中三个产品。现在，我们点击&#8217;下一页&#8217;链接来加载下一页的产品，或者同时在这个页面也选3个产品。然后，我们点击&#8217;上一页&#8217;链接回到之前的页。我们会发现之前选中的3个产品没有被选中，执行排序或是过滤也会导制同样的问题。所以讲，当表格组件搞定了老式多选框的不足后，诸如分页，过滤或是排序这类的操作会导制数据持久性的新问题。</p>

<h3>序列化Block是如何处理数据的可持久性问题</h3>

<p>Magento提供了另外一种Block叫作&#8217;Serializer Block&#8217;(序列化Block)，用它来处理选中数据的持久性问题。这种Block通常情况下会添加在表格Block的后面。该Block包含一个隐藏域和一个序列化过的JS对象。经过序列化的JS对象使用表格JS对象来得到选中的行。然后再序列化，像这样: key1=value1&amp;key2=value2&amp;…，再把经过序列化后的值赋给隐藏域。因为这个Block并没有嵌套在表格Block里面，所以即使是通过AJAX方式重新加载了表格Block，但是值被保存了下来。这个经过序列化过后的值，作为表单的一部分提交，在PHP端则通过 <code>parse_str()</code>函数来反序列化。</p>

<p>不管怎么说，表单元素不光是用来存储用户输入的数据，同时也要显示之前已经保存过的数据。打个比方，当我们在文本框里填写了一些文本，那么我们填写的内容就会显示在里面。当我们从下拉框里面选中了任何一项，那么它就会默认显示我们选中的选项。同理，在此表格组件中也应该能显示选中的行。换句话讲，选中的行应该在第一列的checkbox里标记为checked。</p>

<p>因此，序列化的JS对象在观察者事件观察表格的JS对象行为。所以当一个表格Block重载的时候，序列化的JS对象自动选中我们之前已经选中的行。</p>

<p>那么，基于以上这些理论，我们可以把注意力放在怎么用这些知识去打造一个自定义的后台表格系统。</p>

<h3>使用序列化表格Block</h3>

<p>Magento提供了一个内置的库用来创建自定义表格和序列化Block。我们用追加销售表格来分析理解一下它是怎么工作的。</p>

<p>在产品的编辑页面，左侧有一标签-追加销售。标签内容是通过AJAX加载。点击标签访问这个Action: Mage_Adminhtml_Catalog_ProductController::upsellAction()。</p>

<p>那么该行为的布局就定义在下面的布局文件里 <code>app/design/adminhtml/default/default/catalog.xml</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;adminhtml_catalog_product_upsell&gt;
</span><span class='line'>    &lt;block type="core/text_list" name="root"&gt;
</span><span class='line'>        &lt;block type="adminhtml/catalog_product_edit_tab_upsell" name="catalog.product.edit.tab.upsell"/&gt;
</span><span class='line'>        &lt;block type="adminhtml/widget_grid_serializer" name="upsell_grid_serializer"&gt;
</span><span class='line'>            &lt;reference name="upsell_grid_serializer"&gt;
</span><span class='line'>                &lt;action method="initSerializerBlock"&gt;
</span><span class='line'>                    &lt;grid_block_name&gt;catalog.product.edit.tab.upsell&lt;/grid_block_name&gt;
</span><span class='line'>                    &lt;data_callback&gt;getSelectedUpsellProducts&lt;/data_callback&gt;
</span><span class='line'>                    &lt;hidden_input_name&gt;links[upsell]&lt;/hidden_input_name&gt;
</span><span class='line'>                    &lt;reload_param_name&gt;products_upsell&lt;/reload_param_name&gt;
</span><span class='line'>                &lt;/action&gt;
</span><span class='line'>                &lt;action method="addColumnInputName"&gt;
</span><span class='line'>                    &lt;input_name&gt;position&lt;/input_name&gt;
</span><span class='line'>                &lt;/action&gt;
</span><span class='line'>            &lt;/reference&gt;
</span><span class='line'>        &lt;/block&gt;
</span><span class='line'>    &lt;/block&gt;
</span><span class='line'>&lt;/adminhtml_catalog_product_upsell&gt;</span></code></pre></td></tr></table></div></figure>


<p>这里，Block根节点是 core/text_list 类型。所以所有的子节点全都都按照顺序渲染。请看<a href="http://magebase.com/magento-tutorials/demystifying-magentos-layout-xml-part-1/">Demystifying Magento’s Layout XML Part 1</a>。</p>

<p>第一个子Block <code>catalog.product.edit.tab.upsell</code> 是 <code>adminhtml/catalog_product_edit_tab_upsell</code>类型，继承自 <code>Mage_Adminhtml_Block_Widget_Grid</code>。所以它创建了一个表格。第二个子Block <code>adminhtml/widget_grid_serializer</code> 是 <code>adminhtml/widget_grid_serializer</code> 类型，此类型是序列化Block。就像我们之前提到的，序列化Block是会添加到表格Block后面。</p>

<p>在XML布局文件中，拿序列化Block打比方，<code>方法 initSerializerBlock有如下几个参数:</code></p>

<ol>
<li>grid_block_name: 在布局文件中定义表格Block的名字，在我们的例子中叫作 <code>catalog.product.edit.tab.upsell</code>.</li>
<li>dta_callback: 该参数定义了一个方法，用来取到已选中的数据，并填写在表格Block里。</li>
<li>hidden_input_name: 隐藏域，从POST表单中取得提交的值。在我们的例子里是 links[upsell]。</li>
<li>reload_param_name: 该参数定义了当表格Block通过AJAX分页/过滤/排序等操作时，checkbox的表单名，在我们的例子里是 <code>products_upsell</code>。</li>
</ol>


<p>当序列化Block初始化的时候，它会调用在 data_callback 里定义的方法用来得到初始数据，填入表格Block。在我们的例子中，这个方法为 <code>getSelectedUpsellProducts()</code>。下面便是追加销售表格Block里的相关代码:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public function getSelectedUpsellProducts()
</span><span class='line'>{
</span><span class='line'>    $products = array();
</span><span class='line'>    foreach (Mage::registry('current_product')-&gt;getUpSellProducts() as $product) {
</span><span class='line'>        $products[$product-&gt;getId()] = array('position' =&gt; $product-&gt;getPosition());
</span><span class='line'>    }
</span><span class='line'>    return $products;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这里，该方法返回所有已经存储了的追加销售产品。序列化JS对象把这个返回值存到序列化元素里。基本上，当我们的表格第一次加载的时候，序列化把所有存储在数据库里的数据标记为选中。</p>

<p>在表格Block中，受保护方法(protected)_prepareCoumns()用来定义列。那么追加销售表格Block的第一列就标记为checkbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$this-&gt;addColumn('in_products', array(
</span><span class='line'>  'header_css_class' =&gt; 'a-center',
</span><span class='line'>  'type' =&gt; 'checkbox',
</span><span class='line'>  'name' =&gt; 'in_products',
</span><span class='line'>  'values' =&gt; $this-&gt;_getSelectedProducts(),
</span><span class='line'>  'align' =&gt; 'center',
</span><span class='line'>  'index' =&gt; 'entity_id'
</span><span class='line'>));</span></code></pre></td></tr></table></div></figure>


<p>这里，类型(type)被定义为 <code>checkbox</code>，所以说每一行的这一列将会被显示checkbox。values定义了checkbox的值，以此类推。产品ID对应的checkboxs应该被选中。这里<code>$this-&gt;_getSelectedProducts()</code>方法用来取得选中的数据。</p>

<p>在追加销售产品Block里面还有一个方法 <code>getGridUrl()</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public function getGridUrl() {
</span><span class='line'>  return $this-&gt;_getData('grid_url') ? $this-&gt;_getData('grid_url') : $this-&gt;getUrl('*/*/upsellGrid', array('_current'=&gt;true));
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>该方法定义了通过AJAX进行诸如分页，排序，过滤的操作时调用的URL。这个URL应该仅仅只是返回表格Block，而不会包含另外其它的Block，比如说是序列化Block。</p>

<p>该URL里面方法的实体如下所示:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public function upsellGridAction() {
</span><span class='line'>  $this-&gt;_initProduct();
</span><span class='line'>  $this-&gt;loadLayout();
</span><span class='line'>  $this-&gt;getLayout()-&gt;getBlock('catalog.product.edit.tab.upsell')
</span><span class='line'>  -&gt;setProductsUpsell($this-&gt;getRequest()-&gt;getPost('products_upsell', null));
</span><span class='line'>  $this-&gt;renderLayout();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>该方法对应的布局XML如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;adminhtml_catalog_product_upsellgrid&gt;
</span><span class='line'>  &lt;block type="core/text_list" name="root"&gt;
</span><span class='line'>      &lt;block type="adminhtml/catalog_product_edit_tab_upsell" name="catalog.product.edit.tab.upsell"/&gt;
</span><span class='line'>  &lt;/block&gt;
</span><span class='line'>&lt;/adminhtml_catalog_product_upsellgrid&gt;</span></code></pre></td></tr></table></div></figure>


<p>序列化Block添加了一个隐藏域名为<code>hidden_input_name</code>。当用户选择了任意一行，序列化数据将会被存储到该隐藏域。当用户浏览下/上一页，排序或是过滤数据时，表格通过AJAX加载，选中的数据作为名为<code>reload_param_name</code>的参数通过AJAX来传递。<code>reload_param_name</code>这里是设为<code>products_upsell</code>。在之前提到的方法<code>upsellGridAction()</code>里，POST提交过来的<code>products_upsell</code>是通过<code>setProductsUpsell()</code>方法传递和取得的，并显示在追加销售Blcok实例里。所以说，调用<code>getProductsUpsell()</code>方法将会返回之前选中的数据。</p>

<p>我之前有提到过<code>$this-&gt;_getSelectedProducts()</code>是用来得到选中的数据。下面是该方法的内容:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protected function _getSelectedProducts() {
</span><span class='line'>  $products = $this-&gt;getProductsUpsell();
</span><span class='line'>  if (!is_array($products)) {
</span><span class='line'>      $products = array_keys($this-&gt;getSelectedUpsellProducts());
</span><span class='line'>  }
</span><span class='line'>  return $products;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>之前有提到过，可以通过调用追加销售Block实例里的<code>getProductsUpsell()</code>方法来得到选中的数据。在这个方法里，首先试着通过调用这个方法取得数据。但是在我们的例子里，我们正在试图编辑一个产品，并且，在点击追加销售产品标签后，右侧内容加载以来，我们没有做任何改动，这个表格应该显示数据库里已经保存过的数据为选中。不管怎么说，如果没有选过任何产品，表格会通过调用<code>$this-&gt;getSelectedUpsellProducts()</code>来取得之前保存过的数据。</p>

<p>最后，当产品表单提交后，可以通过POST对象的<code>hidden_input_name</code>来取得选中的数据，在我们的例子里是<code>links[upsell]</code>。这个数据仍然是序例化格式的，Magento提供了一个Helper方法来解码这个数据: <code>Mage::helper('adminhtml/js')-&gt;decodeGridSerializedInput()</code>。</p>

<p>产品控制器在执行真正的保存操作之前会调用<code>_initSave()</code>方法。这个方法就是用来解码序例化数据:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$links = $this-&gt;getRequest()-&gt;getPost('links');
</span><span class='line'>…
</span><span class='line'>if ( isset($links['upsell']) && !$product-&gt;getUpsellReadonly() ) {
</span><span class='line'>  $product-&gt;setUpsellLinkData(Mage::helper('adminhtml/js')-&gt;decodeGridSerializeInput($links['upsell']));`</span></code></pre></td></tr></table></div></figure>


<p>最后，总结一下，完整的表格序列化Block执行过程按顺序如下:
1. 初始化，表格和序例华Block加载。
2. 当序例化Block初始完成后，会加载已保存的数据，并将它以序例化格式存在一个隐藏域中，并以选中的形式显示在表格Block里。
3. 用户执行的任何修改都将同时在隐藏域里反应出来。
4. 分页/排序/过滤等操作只会加载表格，而不是整个序例华Block，这样我们的数据就不会丢失。
5. 当重新载入的时候，选中的数据会通过AJAX以POST的方式传递。
6. 表格Block会试着从POST里取得数据，如果没有，会取得数据库中已经保存过的数据。
7. 当表单提交后，选中的数据以序例华的方式传递。
8. 最后，解码选中的数据并 存储到数据里。</p>

<h3>总结</h3>

<p>在这篇文章里，我们拿追加销售产品作为例子来分析怎么组合使用表格和序例化Block来作为传统多选框的替代方案。在该系例的下一篇文章里，我将会描述更多关于表格序例化的高级功能，这些功能可以创建更大，用户界面更友好的自定义widgets。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-03T10:49:00+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>, <a class='category' href='/blog/categories/fan-yi/'>翻译</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/06/02/magento-widget-form-container-problem/">
		
			Magento Widget Form Container 错误</a>
	</h2>
	<div class="entry-content">
		<p>当我在后台创建一个表单里，出现了下面这个错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Fatal error: Call to a member function setData() on a non-object in app/code/core/Mage/Adminhtml/Block/Widget/Form/Container.php on line 129</span></code></pre></td></tr></table></div></figure>


<p>我很花了些工夫来找出问题，在GOOGLE了一通后，我发现实际情况是Magento没有找到对应的 Form Container。</p>

<p>在Magento后台的开发过程是，Widget Forms 被用来编辑表单实体(entity)，你需要 Mage_Adminhtml_Block_Widget_Form_Container 来包含 Mage_Adminhtml_Block_Widget_Form ( 还有tabs )。</p>

<p>通常情况下，Container 要找到一个 Form，它需要三个属性，像下面这样：</p>

<ul>
<li>protected $_blockGroup = &#8216;moduleName&#8217;;</li>
<li>protected $_controller = &#8216;pathToModuleController&#8217;;</li>
<li>protected $_mode = &#8216;edit&#8217;;</li>
</ul>


<p>这几个属性用来寻找表单，在父类中，真实情况是这样的：
<code>$this-&gt;getLayout()-&gt;createBlock($this-&gt;_blockGroup . '/' . $this-&gt;_controller . '_' . $this-&gt;_mode . '_form')</code></p>

<p>在我的例子里，它将会是这样&#8221;moduleName/pathToModuleController_edit_form&#8221;，这样就创建了一个Block实例。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-02T20:38:00+08:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/05/28/enable-template-hints-in-magento-backend/">
		
			在Magento后台开启Hint</a>
	</h2>
	<div class="entry-content">
		<p>经常写Magento的人对前台的Hints并不陌生，开启了Hints之后，对Block的查找很方便，特别是那些嵌套得很厉害的页面来讲。但是很少有人知道其实后台也可以开启这个功能，不过不是在管理页面打开，需要直接在表里面添加一条数据，像下面这样。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`INSERT INTO `core_config_data` (`scope`, `scope_id`, `path`, `value`)
</span><span class='line'>       VALUES ('websites', '0', 'dev/debug/template_hints', '1');`</span></code></pre></td></tr></table></div></figure>


<p>1表示开启，0表示关闭，当然，你把这条记录删掉也行。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-05-28T11:56:00+08:00" pubdate data-updated="true">May 28<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/04/15/add-custom-variables-in-email-template/">
		
			在Magento邮件模板中添加自定义变量</a>
	</h2>
	<div class="entry-content">
		<p>这几天在Magento开发上遇到一个问题，就是在Email模板中显示自定义的变量。</p>

<p>很简单的扩展：</p>

<ol>
<li>找到当前需要修改的Email模板，模板放在 <code>{ $website_root }/app/locale/{ $language }/template/email/</code></li>
<li>找到对应的模块，从相应的模版名字可以看出来。比如说 <code>order_new.html</code> 是 <code>Mage_Sales_Model_Order</code> 模块。</li>
<li>找到发送邮件的方法，<code>order_new.html</code> 对应的发送邮件方法是 <code>sendNewOrderEmail</code></li>
<li>在该方法中查找 <code>$mailer-&gt;setTemplateParams</code>的方法，里面的参数就是将会在页面中显示的变量/对象。</li>
</ol>


<p>稍微修改下就成了，就这么简单。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-04-15T10:27:00+08:00" pubdate data-updated="true">Apr 15<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>


</div>
	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/04/14/zai-magentozhong-he-bing-javascript-ding-hui-ti-sheng-fang-wen-su-du-ma/">
		
			在Magento中合并JavaScript一定会提升访问速度吗</a>
	</h2>
	<div class="entry-content">
		<p>本文译自<a href="http://fishpig.co.uk/blog/why-you-shouldnt-merge-javascript-in-magento.html">fishpig</a></p>

<p>很多人 - 包括我自己 - 认为把所有的独立JS文件合并成一个文件是一个提升前端速度不错的的方法。道理很简单，合并文件，自然就减少了浏览器在加载页面时的请求数量，好处自然就是缩短完成请求的时间，让页面载入更快。让我们通过Magento中的一个例子来看看它是怎么处理的。</p>

<p>设想一下你刚刚在后台开启了Javascript 合并功能，这时有人来浏览你的网站。Magento将整理所有的XML布局文件并且判断在首页应该包含哪些Javascript。所有的这些被请求的JS文件都会被合并成一个单一文件并且以MD5加密的文件名来存储，此新文件，比如说是 f0eb853c09ba3e46ad21fb89b8d57626.js，只为那些浏览过该网页并保存在浏览器缓存中的用户服务。</p>

<p>接下来，用户点击一个链接进入到目录页面。这时，Magento会再一次整理所有的XML布局文件并且判断目录页面会用到哪些JS文件。此时，Magento 会发现在首页用到的JS文件同样也会在目前的页面中用到，这一次不同，浏览器知道自己已经下载了这个文件，便不会再次下载。相反，文件会从用户的缓存中加载以节省时间，带宽和CPU资源！</p>

<p>目前为止，一切都运行的好好的，我们通过减少对服务器的请求让页面变快了，但是……</p>

<p>接下来，用户被一个产品吸引，于是点击进去到详细页面浏览。再一次，Magento判定哪些在布局文件(XML)里的JS文件需要被加载。此时，Magento发现会用到首页已经加载的JS文件，当然还有两个新文件需要加载。但是已有的合并文件中不存在这样的内容，于是Magento会新建一个名为139f9771ba2ba0cae754978fab4a3c35.js的文件。粗略估计该文件的80％和首页的脚本文件一样，已经被用户下载并缓存了。但还是会迫使用户下载该文件全部内容！虽然此文件的80％已经缓存了，但用户的浏览器完全不知情，还是会下载该文件并缓存！</p>

<p>合并JS文件的初衷是为了减少页面的加载时间，但是在上述场景里，用户被迫再次下载一大块代码！这样做毫无疑问增加了页面载入时间（下载并不需要下载的JS文件，差不多有～40kb），这样做的结果反而和合并文件的初衷相违被。</p>

<p>让我们来看看如果不开启合并JS会怎样。</p>

<p>当用户第一次访问首页时，之前合并过的JS文件在这次请求中会被单独下载。虽然这些文件整个大小和之前合并文件的大小一致，但是请求时间会比较长，因为文件都是被单独请求/下载/缓存的。</p>

<p>接下来，用户访问分类页面，这个页面用到了和之前在浏览首页时下载/缓存过的文件。结果就是此页面加载的时间和之前合并JS后加载页面用的时间一样。在这两种情况下，所有需要用到的JS文件都已经下载下来并且已经缓存了，总而言之，浏览器可以不管这些文件了。</p>

<p>最后，用户访问了产品页面，此页面把之前在首页和分类页面加载过的文件，除此之外加载两个新文件。这些文件已经在首页或是分类页面缓存过了，所以浏览器直接跳过下载，并且缓存两个之前并没有访问过的文件！同时，Magento首页用到的文件占到了产品页面里JS文件数量的80%。当关闭合并选项后，我们就直接的下载了剩下的20%。在之前的合并例子里，等于说是整个重新下载了一遍！</p>

<p>问题就是用户在访问不同页面时，JS文件也会有不同的组合，这样难免在一个页面中漏掉某一个JS，每当这种情况发生时，用户就会被强迫下载之前已经下载过的文件，并以另一个文件名保存。</p>

<h3>怎么办?</h3>

<p>当Magento的合并功能有问题时，就只能动手作些小修改了。</p>

<p>在Magento里面，Javascript是通过XML文件里的Head block或是数组来循环添加到HTML里。我们建议加一个额外的参数在你的Javascript包含代码里，看下面的代码：</p>

<pre><code>&lt;default&gt;
    &lt;reference name="head"&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;prototype/prototype.js&lt;/script&gt;&lt;group&gt;global&lt;/group&gt;&lt;/action&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;scriptaculous/builder.js&lt;/script&gt;&lt;group&gt;global&lt;/group&gt;&lt;/action&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;scriptaculous/effects.js&lt;/script&gt;&lt;group&gt;global&lt;/group&gt;&lt;/action&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;varien/form.js&lt;/script&gt;&lt;group&gt;global&lt;/group&gt;&lt;/action&gt;
    &lt;/reference&gt;
&lt;/default&gt;
&lt;catalog_product_view&gt;
    &lt;reference name="head"&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;varien/product.js&lt;/script&gt;&lt;group&gt;product&lt;/group&gt;&lt;/action&gt;
        &lt;action method="addJs"&gt;&lt;script&gt;varien/configurable.js&lt;/script&gt;&lt;group&gt;product&lt;/group&gt;&lt;/action&gt;
    &lt;/reference&gt;
&lt;/catalog_product_view&gt;
</code></pre>

<p>注意到了新参数 group 吗？和合并所有的Javascript到一个文件不一样，group参数将会判断哪些Javascript文件需要合并。上面的代码将会为产品页面生成两个分开的合并文件: 一个是包含在首页里用到的全局Javascript，一个是包含只会在产品页面里用到的文件。虽然这样做会导制额外的请求，但这样做还是会节省时间，因为不用再去下载已经在首页下载过的文件！如果在整站中用到这个小技巧，每一个Javascript将只会被下载一次。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-04-14T15:53:00+08:00" pubdate data-updated="true">Apr 14<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/magento/'>Magento</a>, <a class='category' href='/blog/categories/fan-yi/'>翻译</a>


</div>
	
</div></article>

<nav id="pagenavi">
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Bill Sion

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-40120225-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>